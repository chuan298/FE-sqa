<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="bootstrap-4.3.1-dist/css/bootstrap.css">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <title>Document</title>
</head>

<body>

    <ul class="nav justify-content-center nav-pills nav-tabs ">
        <li class="nav-item">
            <a class="nav-link" href="#">Xếp lịch</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="xemlich.html">Xem lịch đăng ký</a>
        </li>
    </ul>
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn môn học</p>
                </div>
                <div class="col-sm-9">
                    <select id="subjects" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Nhập mã nhóm môn học</p>
                </div>
                <div class="col-sm-9">
                    <input type="text" id="code">
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Nhập nhóm môn học</p>
                </div>
                <div class="col-sm-9">
                    <input type="text" id="group">
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn phòng học kíp 1</p>
                </div>
                <div class="col-sm-9">
                    <select id="rooms1" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn kíp học 1</p>
                </div>
                <div class="col-sm-9">
                    <select id="shift1" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn ngày kíp học 1</p>
                </div>
                <div class="col-sm-9">
                    <select id="dayshift1" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn tuần kíp học 1</p>
                </div>
                <div class="col-sm-9">
                    <div class="row" id="kip1weeks">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn phòng học kíp 2</p>
                </div>
                <div class="col-sm-9">
                    <select id="rooms2" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row kiphoc2">
                <div class="col-sm-3">
                    <p class="k2">Chọn kíp học 2</p>
                </div>
                <div class="col-sm-9">
                    <select id="shift2" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn ngày kíp học 2</p>
                </div>
                <div class="col-sm-9">
                    <select id="dayshift2" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row kiphoc2">
                <div class="col-sm-3">
                    <p class="k2">Chọn tuần kíp học 2</p>
                </div>
                <div class="col-sm-9">
                    <div class="row" id="kip2weeks">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn phòng thực hành 1</p>
                </div>
                <div class="col-sm-9">
                    <select id="1practice_rooms" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Nhập tổ thực hành 1</p>
                </div>
                <div class="col-sm-9">
                    <input type="text" id="1groupPractice">
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn kíp thực hành 1</p>
                </div>
                <div class="col-sm-9">
                    <select id="1practice_shifts" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn ngày thực hành 1</p>
                </div>
                <div class="col-sm-9">
                    <select id="1daypractice" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn tuần thực hành 1</p>
                </div>
                <div class="col-sm-9">
                    <div class="row" id="1practiceWeeks">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn phòng thực hành 2</p>
                </div>
                <div class="col-sm-9">
                    <select id="2practice_rooms" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Nhập tổ thực hành 2</p>
                </div>
                <div class="col-sm-9">
                    <input type="text" id="2groupPractice">
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn kíp thực hành 2</p>
                </div>
                <div class="col-sm-9">
                    <select id="2practice_shifts" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn ngày thực hành 2</p>
                </div>
                <div class="col-sm-9">
                    <select id="2daypractice" style="width: 50%;">
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-3">
                    <p class="">Chọn tuần thực hành 2</p>
                </div>
                <div class="col-sm-9">
                    <div class="row" id="2practiceWeeks">
                    </div>
                </div>
            </div>
            <!--------->
            <br><br>
            <div class="text-center">
                <button class="btn btn-primary" id="btnFetch">
                    Xếp lịch
                </button>
            </div>

        </div>

    </div>







</body>
<script type="text/javascript" src="httpServices.js"></script>
<script type="text/javascript">
    /////// init kip1weeks
    for (let i = 1; i <= 10; i++) {
        $('#kip1weeks').append(
            '<div class="custom-control custom-checkbox col"> <input type = "checkbox" class= "custom-control-input" id = "s1tuan' + i + '"> <label class="custom-control-label" for="s1tuan' + i + '">' + i + '</label> </div>'
        )
    }
    /////// init kip2weeks
    for (let i = 1; i <= 10; i++) {
        $('#kip2weeks').append(
            '<div class="custom-control custom-checkbox col"> <input type = "checkbox" class= "custom-control-input" id = "s2tuan' + i + '"> <label class="custom-control-label" for="s2tuan' + i + '">' + i + '</label> </div>'
        )
    }
    /////// init 1practiceWeeks
    for (let i = 1; i <= 10; i++) {
        $('#1practiceWeeks').append(
            '<div class="custom-control custom-checkbox col"> <input type = "checkbox" class= "custom-control-input" id = "p1tuan' + i + '"> <label class="custom-control-label" for="p1tuan' + i + '">' + i + '</label> </div>'
        )
    }
    /////// init 2practiceWeeks
    for (let i = 1; i <= 10; i++) {
        $('#2practiceWeeks').append(
            '<div class="custom-control custom-checkbox col"> <input type = "checkbox" class= "custom-control-input" id = "p2tuan' + i + '"> <label class="custom-control-label" for="p2tuan' + i + '">' + i + '</label> </div>'
        )
    }
    ////// init dayshift1
    for (let i = 2; i <= 7; i++) {
        $('#dayshift1').append('<option value="s1thu' + i + '">Thứ ' + i + '</option>')
    }
    $('#dayshift1').append('<option value="s1thu' + 8 + '">Chủ nhật</option>')
    ////// init dayshift2
    for (let i = 2; i <= 7; i++) {
        $('#dayshift2').append('<option value="s2thu' + i + '">Thứ ' + i + '</option>')
    }
    $('#dayshift2').append('<option value="s2thu' + 8 + '">Chủ nhật</option>')
    ////// init 1daypractice
    for (let i = 2; i <= 7; i++) {
        $('#1daypractice').append('<option value="p1thu' + i + '">Thứ ' + i + '</option>')
    }
    $('#1daypractice').append('<option value="p1thu' + 8 + '">Chủ nhật</option>')
    ////// init 2daypractice
    for (let i = 2; i <= 7; i++) {
        $('#2daypractice').append('<option value="p2thu' + i + '">Thứ ' + i + '</option>')
    }
    $('#2daypractice').append('<option value="p2thu' + 8 + '">Chủ nhật</option>')


    //////////////////// get practice room in db
    let fetch_get_practice_rooms = get("http://localhost:8080/api/practice-rooms/")
        .then(fetch_get_practice_rooms => {
            console.log({ fetch_get_practice_rooms })
            if (fetch_get_practice_rooms.code === "00") { // check if get success then add rooms to tag selection
                const practice_rooms = fetch_get_practice_rooms.data
                select1 = document.getElementById('1practice_rooms');
                practice_rooms.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = element.name;
                    select1.appendChild(opt);
                });
                select2 = document.getElementById('2practice_rooms');
                practice_rooms.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = element.name;
                    select2.appendChild(opt);
                });
            }
        })
    /////////////// get practice shift in db
    let fetch_get_practice_shifts = get("http://localhost:8080/api/practice-shifts/")
        .then(fetch_get_practice_shifts => {
            console.log({ fetch_get_practice_shifts })
            if (fetch_get_practice_shifts.code === "00") { // check if get success then add rooms to tag selection
                const practice_shifts = fetch_get_practice_shifts.data
                select1 = document.getElementById('1practice_shifts');
                practice_shifts.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = "Tiết " + element.startLesson + " đến tiết " + element.endLesson;
                    select1.appendChild(opt);
                });
                select2 = document.getElementById('2practice_shifts');
                practice_shifts.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = "Tiết " + element.startLesson + " đến tiết " + element.endLesson;
                    select2.appendChild(opt);
                });
            }
        })
    ////////////// get room in db
    let fetch_get_rooms = get("http://localhost:8080/api/rooms/")
        .then(fetch_get_rooms => {
            console.log({ fetch_get_rooms })
            if (fetch_get_rooms.code === "00") { // check if get success then add rooms to tag selection
                const rooms = fetch_get_rooms.data
                select1 = document.getElementById('rooms1');
                rooms.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = element.name;
                    select1.appendChild(opt);
                });
                select2 = document.getElementById('rooms2');
                rooms.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = element.name;
                    select2.appendChild(opt);
                });
            }
        })
    ////////////// get shift in db
    let fetch_get_shifts = get("http://localhost:8080/api/shifts/")
        .then(fetch_get_shifts => {
            console.log({ fetch_get_shifts })
            if (fetch_get_shifts.code === "00") { // check if get success then add rooms to tag selection
                const shifts = fetch_get_shifts.data
                select1 = document.getElementById('shift1');
                select2 = document.getElementById('shift2')
                shifts.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = "Tiết " + element.startLesson + " đến tiết " + element.endLesson;
                    select1.appendChild(opt);
                });
                shifts.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id;
                    opt.innerHTML = "Tiết " + element.startLesson + " đến tiết " + element.endLesson;
                    select2.appendChild(opt);
                });
            }
        })
    ////////////// get subjects in db
    let fetch_get_subjects = get("http://localhost:8080/api/subjects/")
        .then(fetch_get_subjects => {
            console.log({ fetch_get_subjects })
            if (fetch_get_subjects.code === "00") {
                const subjects = fetch_get_subjects.data
                select = document.getElementById('subjects');
                subjects.forEach(element => {
                    var opt = document.createElement('option');
                    opt.value = element.id + " " + element.lessonNumber2 + " " + element.practiceNumber;
                    opt.innerHTML = element.code + " - " + element.name;
                    select.appendChild(opt);
                });
            }
        })
    /////////////
    $(document).ready(() => { // all interface loaded

        console.log($("#subjects :selected").val())
        if (!$("#subjects :selected").val()) { //  kiểm tra nếu không có môn nào được chọn thì disable tất cả các trường còn lại
            $("#code").prop("disabled", "disabled")
            $("#group").prop("disabled", "disabled")
            $("#dayshift1").prop("disabled", "disabled")
            $("#rooms1").prop("disabled", "disabled")
            $("#shift1").prop("disabled", "disabled")
            for (let i = 1; i <= 15; i++) {
                $("#s1tuan" + i).attr("disabled", true)
            }

            $("#dayshift2").prop("disabled", "disabled")
            $("#rooms2").prop("disabled", "disabled")
            $("#shift2").prop("disabled", "disabled")
            for (let i = 1; i <= 15; i++) {
                $("#s2tuan" + i).attr("disabled", true)
            }

            $("#1daypractice").prop("disabled", "disabled")
            $("#1practice_rooms").prop("disabled", "disabled")
            $("#1practice_shifts").prop("disabled", "disabled")
            for (let i = 1; i <= 15; i++) {
                $("#p1tuan" + i).attr("disabled", true)
            }
            $("#1groupPractice").prop("disabled", "disabled")

            $("#2daypractice").prop("disabled", "disabled")
            $("#2practice_rooms").prop("disabled", "disabled")
            $("#2practice_shifts").prop("disabled", "disabled")
            for (let i = 1; i <= 15; i++) {
                $("#p2tuan" + i).attr("disabled", true)
            }
            $("#2groupPractice").prop("disabled", "disabled")
        }
        $("#subjects").change(function () {
            ///////////////////// mỗi lần đổi môn học sẽ xóa dữ liệu đã được chọn hoặc điền trước đó
            $("#code").val("")
            $("#group").val("")
            $("#dayshift1").prop("value", "")
            $("#rooms1").prop("value", "")
            $("#shift1").prop("value", "")
            for (let i = 1; i <= 15; i++) {
                $("#s1tuan" + i).prop('checked', false)
            }
            $("#dayshift2").prop("value", "")
            $("#rooms2").prop("value", "")
            $("#shift2").prop("value", "")
            for (let i = 1; i <= 15; i++) {
                $("#s2tuan" + i).prop('checked', false)
            }

            $("#1groupPractice").val("")
            $("#1daypractice").prop("value", "")
            $("#1practice_rooms").prop("value", "")
            $("#1practice_shifts").prop("value", "")
            for (let i = 1; i <= 15; i++) {
                $("#p1tuan" + i).prop('checked', false)
            }

            $("#2groupPractice").val("")
            $("#2daypractice").prop("value", "")
            $("#2practice_rooms").prop("value", "")
            $("#2practice_shifts").prop("value", "")
            for (let i = 1; i <= 15; i++) {
                $("#p2tuan" + i).prop('checked', false)
            }
            ////////////////////
            // 
            const val = $("#subjects :selected").val() // Lấy giá trị của môn học đang được chọn (val = subject.id + " " + subject.lessonNumber2 + " " + subject.practiceNumber;)
            const val_split = val.split(" ")
            console.log(val, val_split[0], val_split[1], val_split[2])
            if (!val) { // nếu giá trị của môn học đang được chọn ko tồn tại (tức là ô chọn là ô trống) thì set disable tất cả các trường còn lại
                $("#code").prop("disabled", "disabled")
                $("#group").prop("disabled", "disabled")
                $("#dayshift1").prop("disabled", "disabled")
                $("#rooms1").prop("disabled", "disabled")
                $("#shift1").prop("disabled", "disabled")
                for (let i = 1; i <= 15; i++) {
                    $("#s1tuan" + i).prop("disabled", "disabled")
                }
            }
            else { // nếu giá trị của môn học đang được chọn tồn tại thì enable các trường của kíp học 1
                $("#code").prop("disabled", false)
                $("#group").prop("disabled", false)
                $("#dayshift1").prop("disabled", false)
                $("#rooms1").prop("disabled", false)
                $("#shift1").prop("disabled", false)
                for (let i = 1; i <= 15; i++) {
                    $("#s1tuan" + i).prop("disabled", false)
                }
            }
            if (!val || parseInt(val_split[1]) === 0) { // kiểm tra môn học đó có 2 kíp ko? (subject.lessonNumber2) 
                $("#dayshift2").prop("disabled", "disabled")
                $("#rooms2").prop("disabled", "disabled")
                $("#shift2").prop("disabled", "disabled")
                for (let i = 1; i <= 15; i++) {
                    $("#s2tuan" + i).prop("disabled", "disabled")
                }
            }
            else { // nếu không thì enable các trường kíp 2
                $("#dayshift2").prop("disabled", false)
                $("#rooms2").prop("disabled", false)
                $("#shift2").prop("disabled", false)
                for (let i = 1; i <= 15; i++) {
                    $("#s2tuan" + i).prop("disabled", false)
                }
            }
            if (!val || parseInt(val_split[2]) === 0) { // kiểm tra môn đó có thực hành ko? (subject.practiceNumber)
                $("#1groupPractice").prop("disabled", "disabled")
                $("#1daypractice").prop("disabled", "disabled")
                $("#1practice_rooms").prop("disabled", "disabled")
                $("#1practice_shifts").prop("disabled", "disabled")
                for (let i = 1; i <= 15; i++) {
                    $("#p1tuan" + i).prop("disabled", "disabled")
                }

                $("#2groupPractice").prop("disabled", "disabled")
                $("#2daypractice").prop("disabled", "disabled")
                $("#2practice_rooms").prop("disabled", "disabled")
                $("#2practice_shifts").prop("disabled", "disabled")
                for (let i = 1; i <= 15; i++) {
                    $("#p2tuan" + i).prop("disabled", "disabled")
                }
            }
            else { // nếu ko thì enable các trường thực hành
                $("#1groupPractice").prop("disabled", false)
                $("#1daypractice").prop("disabled", false)
                $("#1practice_rooms").prop("disabled", false)
                $("#1practice_shifts").prop("disabled", false)
                for (let i = 1; i <= 15; i++) {
                    $("#p1tuan" + i).prop("disabled", false)
                }

                $("#2groupPractice").prop("disabled", false)
                $("#2daypractice").prop("disabled", false)
                $("#2practice_rooms").prop("disabled", false)
                $("#2practice_shifts").prop("disabled", false)
                for (let i = 1; i <= 15; i++) {
                    $("#p2tuan" + i).prop("disabled", false)
                }
            }
            ///////////////////////

        })

        $("#btnFetch").click(function () { // click xếp lịch
            $(this).prop("disabled", true); // trong lúc click thì disable nút
            $(this).append(
                `<span id="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`
            );
            /////////////////////////// post schedule
            let week1 = "", week2 = "", weekPractice1 = "", weekPractice2 = ""
            // khởi tạo tuần
            for (let i = 1; i <= 10; i++) {
                if ($("#s1tuan" + i).is(":checked")) {
                    week1 += $("#s1tuan" + i).next('label').text() + ", "
                }
                if ($("#s2tuan" + i).is(":checked")) {
                    week2 += $("#s2tuan" + i).next('label').text() + ", "
                }
                if ($("#p1tuan" + i).is(":checked")) {
                    weekPractice1 += $("#p1tuan" + i).next('label').text() + ", "
                }
                if ($("#p2tuan" + i).is(":checked")) {
                    weekPractice2 += $("#p2tuan" + i).next('label').text() + ", "
                }
            }
            // cắt dấu phẩy ở cuối
            week1 = week1.slice(0, week1.length - 2)
            week2 = week2.slice(0, week2.length - 2)
            weekPractice1 = weekPractice1.slice(0, weekPractice1.length - 2)
            weekPractice2 = weekPractice2.slice(0, weekPractice2.length - 2)
            // khởi tạo request để gửi đi bằng dữ liệu đã được điền hoặc chọn
            let request = {
                id_subject: $("#subjects :selected").val().split(" ")[0],
                id_shift1: $("#shift1 :selected").val(),
                id_shift2: $("#shift2 :selected").val() ? $("#shift2 :selected").val() : "1",
                id_room: $("#rooms1 :selected").val(),
                week1: week1,
                week2: week2 ? week2 : "0",
                code: $("#code").val(),
                group: $("#group").val(),
                day: $("#dayshift1 :selected").val()[$("#dayshift1 :selected").val().length - 1],
                id_practice_shift1: $("#1practice_shifts :selected").val() ? $("#1practice_shifts :selected").val() : "1",
                id_practice_shift2: $("#2practice_shifts :selected").val() ? $("#2practice_shifts :selected").val() : "1",
                id_practice_room1: $("#1practice_rooms :selected").val() ? $("#1practice_rooms :selected").val() : "1",
                id_practice_room2: $("#2practice_rooms :selected").val() ? $("#2practice_rooms :selected").val() : "1",
                week_practice1: weekPractice1 ? weekPractice1 : "0",
                week_practice2: weekPractice2 ? weekPractice2 : "0",
                group_practice1: $("#1groupPractice").val() ? $("#1groupPractice").val() : "0",
                group_practice2: $("#2groupPractice").val() ? $("#2groupPractice").val() : "0",
                day_practice1: $("#1daypractice :selected").val() ? $("#1daypractice :selected").val()[$("#1daypractice :selected").val().length - 1] : "0",
                day_practice2: $("#2daypractice :selected").val() ? $("#2daypractice :selected").val()[$("#2daypractice :selected").val().length - 1] : "0"
            }
            console.log({ request })
            // gửi dữ liệu đi
            post("http://localhost:8080/api/schedule/", request)
                .then(response => {
                    $(this).prop("disabled", false); // enable nút sau khi đã có kết quả trả về của xếp lịch
                    $("#loading").remove()
                    console.log(response)
                    alert(response.message)

                })
        });


    });
    /////////////


</script>

</html>